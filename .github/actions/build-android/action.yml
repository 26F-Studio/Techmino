name: 'build Android'
description: 'build Android package'
inputs:
  cc-url:
    required: true
  type:
    required: true
runs:
  using: "composite"
  steps:
    - name: Clone love-android
      shell: bash
      run: |
        git clone --recurse-submodules https://github.com/26F-Studio/love-android
        cd ./love-android
        git checkout --recurse-submodules CI
    - name: Download androidSDK
      uses: ./.github/actions/get-unzip
      with:
        url: https://dl.google.com/android/repository/commandlinetools-linux-7583922_latest.zip
    - name: Install SDK NDK
      shell: bash
      run: |
        yes | ./cmdline-tools/bin/sdkmanager --sdk_root=. --install "platforms;android-30"
        yes | ./cmdline-tools/bin/sdkmanager --sdk_root=. --install "ndk;21.3.6528147"
        export ANDROID_HOME=$(pwd)
    - name: Download ColdClear arm64-v8a
      uses: ./.github/actions/get-unzip
      with:
        url: ${{ inputs.cc-url }}/android_aarch64.zip
        dir: ColdClear/arm64-v8a
    - name: Download ColdClear armeabi-v7a
      uses: ./.github/actions/get-unzip
      with:
        url: ${{ inputs.cc-url }}/android_armv7.zip
        dir: ColdClear/armeabi-v7a
    - uses: ./.github/actions/build-love
      with:
        path: love-android/app/src/main/assets/game.love
    - name: Pack Techmino
      shell: bash
      run: |
        mkdir -p ./love-android/app/src/main/assets
        mkdir -p ./love-android/app/libs/arm64-v8a
        mkdir -p ./love-android/app/libs/armeabi-v7a
        mv ./ColdClear/arm64-v8a/love-11.3-android/lib/arm64-v8a/libcold_clear.so ./love-android/app/libs/arm64-v8a
        mv ./ColdClear/armeabi-v7a/love-11.3-android/lib/armeabi-v7a/libcold_clear.so ./love-android/app/libs/armeabi-v7a
        mkdir -p ./libAndroid/arm64-v8a
        mkdir -p ./libAndroid/armeabi-v7a
        mv ./ColdClear/arm64-v8a/libs/arm64-v8a/libCCloader.so ./libAndroid/arm64-v8a
        mv ./ColdClear/armeabi-v7a/libs/armeabi-v7a/libCCloader.so ./libAndroid/armeabi-v7a
        7z a -tzip love-android/app/src/main/assets/game.love libAndroid
        echo "${{ secrets.SIGNING_KEY }}" | base64 -d > ./love-android/app/android.keystore
        python3 ./.github/workflows/updateVersion.py -T Android${{ inputs.type }} -C ${{ needs.get-version.outputs.code }} -N ${{ needs.get-version.outputs.name }} -S ${{ secrets.KEY_STORE_PASSWORD }} -A ${{ secrets.ALIAS }} -K ${{ secrets.KEY_PASSWORD }}
        chmod 777 ./love-android/gradlew
        cd ./love-android/
        ./gradlew assembleRelease

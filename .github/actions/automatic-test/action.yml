name: 'Automatic Test'
description: 'Check for obvious errors.'

runs:
  using: "composite"
  steps:
  - uses: ./.github/actions/build-love
    with:
      file-path: Techmino.love
  - name: Download love
    shell: bash
    run: |
      curl -L https://github.com/love2d/love/releases/download/11.3/love-11.3-linux-x86_64.tar.gz | tar xz
  - name: Prepare PulseAudio
    shell: bash
    run: |
      sudo apt-get update
      sudo apt-get install pulseaudio pulseaudio-utils pavucontrol alsa-oss alsa-utils -y
  - name: Run automated test
    uses: GabrielBB/xvfb-action@v1
    with:
      run: |
        ./dest/love Techmino.love --test
  - name: Prepare FontTools
    shell: bash
    run: |
      pip install fonttools
  - name: Check fonts
    description: Make sure all characters are present in the font.
    shell: python
    run: |
      from fontTools.ttLib import TTFont
      from pathlib import Path

      font = TTFont('parts/fonts/proportional.otf')
      keys = set(font.getBestCmap().keys())

      missing = []
      for file in Path('parts/language').glob('*.lua'):
        for char in file.read_text():
          if char == '\n':
            continue
          if ord(char) not in keys:
            missing.append((char, file))

      if missing:
        print('Missing characters:')
        for char, file in missing:
          print(f"'{char}'({ord(char):x}) in {file}")
        exit(1)
      else:
        print('All characters are present in the font.')

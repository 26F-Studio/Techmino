name: Techmino Release CI

on:
  workflow_dispatch:
    inputs:
      name:
        description: '将要发布的版本名称'
        required: true
      body:
        description: 'release详细信息'
        required: true
      tag:
        description: 'release使用的tag'
        required: true

jobs:
  build-windows-x64:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Update Conf Version
      run: |
        python .github/workflows/updateConfVersion.py
    - name: Download love
      run: |
        curl -OL https://github.com/love2d/love/releases/download/11.3/love-11.3-win64.zip
    - name: Unpack love
      run: |
        7z x love-11.3-win64.zip
    - name: Download ColdClear
      run: |
        curl -OL https://github.com/26F-Studio/cold_clear_ai_love2d_wrapper/releases/download/latest/win64.zip
    - name: Unpack ColdClear
        7z x win64.zip -oColdClear
    - name: Download ResourceHacker
      run: |
        curl -OL http://www.angusj.com/resourcehacker/resource_hacker.zip
        7z x resource_hacker.zip
    - name: Pack Techmino
      run: |
        7z a -tzip Techmino.love document media parts Zframework conf.lua font.ttf main.lua
        cmd /c copy /b love-11.3-win64\love.exe + Techmino.love love-11.3-win64\Techmino.exe
        del love-11.3-win64\love.exe
        del love-11.3-win64\lovec.exe
        del love-11.3-win64\game.ico
        del love-11.3-win64\love.ico
        del love-11.3-win64\changes.txt
        del love-11.3-win64\readme.txt
        move ColdClear\cold_clear.dll love-11.3-win64
        move ColdClear\CCloader.dll love-11.3-win64
        $Version=python .github/workflows/updateWindowsVersion.py -V ${{ github.event.inputs.tag }}
        echo "Version=${Version}" >> $env:GITHUB_ENV
        ResourceHacker.exe -open love-11.3-win64\Techmino.exe love-11.3-win64\Techmino.exe -action delete -mask ICONGROUP,,
        ResourceHacker.exe -open Techmino.rc -save Techmino.res -action compile
        ResourceHacker.exe -open love-11.3-win64\Techmino.exe -save love-11.3-win64\Techmino.exe -action addoverwrite -res "icon.ico" -mask ICONGROUP,1,
        ResourceHacker.exe -open love-11.3-win64\Techmino.exe -save love-11.3-win64\Techmino.exe -action addoverwrite -res "Techmino.res" -mask VERSIONINFO,1,
        7z a -tzip Techmino.a$Version.Win64.zip love-11.3-win64\
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ github.event.inputs.name }}
        tag_name: ${{ github.event.inputs.tag }}
        files: |
          Techmino.a${{ env.Version }}.Win64.zip

  build-windows-x86:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Update Conf Version
      run: |
        python .github/workflows/updateConfVersion.py
    - name: Download love
      run: |
        curl -OL https://github.com/love2d/love/releases/download/11.3/love-11.3-win32.zip
    - name: Unpack love
      run: |
        7z x love-11.3-win32.zip
    - name: Download ColdClear
      run: |
        curl -OL https://github.com/26F-Studio/cold_clear_ai_love2d_wrapper/releases/download/latest/win32.zip
    - name: Unpack ColdClear
        7z x win32.zip -oColdClear
    - name: Download ResourceHacker
      run: |
        curl -OL http://www.angusj.com/resourcehacker/resource_hacker.zip
        7z x resource_hacker.zip
    - name: Pack Techmino
      run: |
        7z a -tzip Techmino.love document media parts Zframework conf.lua font.ttf main.lua
        cmd /c copy /b love-11.3-win32\love.exe + Techmino.love love-11.3-win32\Techmino.exe
        del love-11.3-win32\love.exe
        del love-11.3-win32\lovec.exe
        del love-11.3-win32\game.ico
        del love-11.3-win32\love.ico
        del love-11.3-win32\changes.txt
        del love-11.3-win32\readme.txt
        move ColdClear\cold_clear.dll love-11.3-win32
        move ColdClear\CCloader.dll love-11.3-win32
        $Version=python .github/workflows/updateWindowsVersion.py -V ${{ github.event.inputs.tag }}
        echo "Version=${Version}" >> $env:GITHUB_ENV
        ResourceHacker.exe -open love-11.3-win32\Techmino.exe love-11.3-win32\Techmino.exe -action delete -mask ICONGROUP,,
        ResourceHacker.exe -open Techmino.rc -save Techmino.res -action compile
        ResourceHacker.exe -open love-11.3-win32\Techmino.exe -save love-11.3-win32\Techmino.exe -action addoverwrite -res "icon.ico" -mask ICONGROUP,1,
        ResourceHacker.exe -open love-11.3-win32\Techmino.exe -save love-11.3-win32\Techmino.exe -action addoverwrite -res "Techmino.res" -mask VERSIONINFO,1,
        7z a -tzip Techmino.a$Version.Win32.zip love-11.3-win32\
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ github.event.inputs.name }}
        tag_name: ${{ github.event.inputs.tag }}
        files: |
          Techmino.a${{ env.Version }}.Win32.zip

  build-linux:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
    - name: Update Conf Version
      run: |
        python3 .github/workflows/updateConfVersion.py
    - name: Download AppImageKit
      run: |
        curl -OL https://github.com/AppImage/AppImageKit/releases/download/latest/appimagetool-x86_64.AppImage
    - name: Download love
      run: |
        curl -OL https://github.com/love2d/love/releases/download/11.3/love-11.3-x86_64.AppImage
    - name: Unpack love
      run: |
        chmod 777 ./love-11.3-x86_64.AppImage
        ./love-11.3-x86_64.AppImage --appimage-extract
    - name: Download ColdClear
      run: |
        curl -OL https://github.com/26F-Studio/cold_clear_ai_love2d_wrapper/releases/download/latest/linux.zip
    - name: Unpack ColdClear
      run: |
        7z x linux.zip -oColdClear
    - name: Pack Techmino
      #暂未完成
      run: |
        7z a -tzip Techmino.love document media parts Zframework conf.lua font.ttf main.lua
        mv Techmino.love squashfs-root/usr/bin
        ./appimagetool-x86_64.AppImage squashfs-root Techmino.a$Version.AppImage
    - name: Upload
      uses: actions/upload-artifact@v2
      with:
        name: Techmino_${{ env.Version }}_CI_${{ GITHUB.RUN_NUMBER }}_${{ env.CommitID }}_Linux
        path: Techmino.AppImage